# プロダクト要求定義書

## 1. プロダクトビジョンと目的

### ビジョン

開発者がターミナルから離れずにタスクを管理でき、優先順位を自動で調整する個人向けタスク管理CLIツール。

### 目的

既存の汎用タスク管理ツール（Todoist、Trello、Asana等）は、開発者のワークフローと断絶している。本プロダクトは以下の課題を解決する。

- **コンテキストスイッチの削減** — ブラウザやGUIアプリに切り替えることなく、ターミナル上でタスク管理を完結させる
- **優先順位判断の負荷軽減** — 期限・依存関係・放置期間・タスク粒度から優先度を自動算出し、「次に何をやるべきか」を常に提示する
- **データのポータビリティ** — Markdownファイルでローカル保存し、ベンダーロックインを排除する

### 既存ツールとの差別化

本プロダクトの核となる差別化要素は「優先度の自動調整」である。既存ツールにもCLIやAPIは存在するが、タスクの優先順位をコンテキスト（期限・依存関係・放置期間・粒度）から自動算出する機能は提供されていない。

| 観点 | 既存ツール（Todoist, Trello等） | 本プロダクト |
|---|---|---|
| 優先順位 | 手動設定のみ（一部フィルタ・ソート機能あり） | 4シグナルによる自動調整 + 手動オーバーライド |
| 操作方式 | GUI中心（CLI/APIは補助的） | CLIファースト |
| データ保存 | クラウド依存 | ローカルMarkdown（Git管理可能） |
| ターゲット | 汎用（全職種） | 開発者特化 |

## 2. ターゲットユーザー

### ペルソナ

**属性:**
- 個人開発者（フリーランス、個人プロジェクト、OSS開発者）
- ターミナル操作に慣れているエンジニア
- 日常的にターミナル、エディタ（VS Code / Vim / Neovim）、Gitを使用

**典型的なシナリオ:**
- 2〜3の個人プロジェクトを並行して進めている
- 常時30〜100個程度のタスクを抱えている
- 現在はテキストファイル、GitHub Issues、またはメモアプリでタスクを管理しているが、優先順位の判断に時間がかかっている
- 作業中にブラウザを開いてタスク管理ツールに切り替えるのを避けたい

**抱えている課題:**
- タスク管理のためにブラウザやGUIアプリに切り替えるのが煩わしい
- タスクが増えると優先順位の判断に時間がかかる
- 既存ツールのデータが手元に残らず、エクスポートしにくい

### タスク規模の想定

| 規模 | タスク数 | サポート状況 |
|---|---|---|
| 小規模 | 〜50個 | 主要ターゲット |
| 中規模 | 50〜200個 | サポート対象 |
| 大規模 | 200〜1000個 | サポート対象（パフォーマンス要件の上限） |
| 超大規模 | 1000個超 | スコープ外 |

### ターゲット外

- チームでのプロジェクト管理を求めるユーザー
- GUI操作を好む非エンジニア
- リアルタイム同期やコラボレーション機能を必要とするユーザー

## 3. 成功指標

| 指標 | 目標 | 測定方法 |
|---|---|---|
| タスク追加の操作ステップ | コマンド1行で完結 | CLIコマンド設計のレビュー |
| `task next` の応答時間 | 1秒以内（200タスク時） | ベンチマークテスト |
| CLI起動時間 | 100ms以下 | ベンチマークテスト（`hyperfine`等） |
| データの可読性 | Front Matterのキー名がタスク属性と1:1対応し、Markdownとして有効な構文である | ファイル形式の仕様レビュー + テキストエディタでの目視確認 |
| データの可搬性 | データディレクトリのコピーのみで別環境に移行できる | 環境移行テスト |

## 4. 機能要件

### 4.1 タスクのCRUD

#### タスク作成

```bash
task add "タスクタイトル" [オプション]
```

| オプション | 短縮形 | 説明 | 例 |
|---|---|---|---|
| `--due <date>` | `-d` | 期限 | `--due=2025-02-10`, `--due=tomorrow`, `--due=friday` |
| `--tag <name>` | `-t` | タグ（複数指定可） | `--tag=frontend --tag=urgent` |
| `--estimate <value>` | `-e` | 見積もり | `--estimate=2h`, `--estimate=30m`, `--estimate=3p` |
| `--note <text>` | `-n` | メモ | `--note="API仕様を確認してから着手"` |
| `--depends <id>` | `-D` | 依存タスク（複数指定可） | `--depends=12 --depends=15` |

**期限（`--due`）の対応フォーマット:**
- 絶対日付: `YYYY-MM-DD`（例: `2025-02-10`）
- 相対日付: `today`, `tomorrow`, `+3d`（3日後）, `+1w`（1週間後）
- 曜日指定: `monday`, `friday`（次のその曜日）

**見積もり（`--estimate`）の単位:**
- `m`: 分（例: `30m`）
- `h`: 時間（例: `2h`）
- `p`: ポイント（例: `3p`、抽象的な作業量）
- スコアリングでは時間単位に正規化する。ポイントの場合は `1p = 1h` として換算する（設定ファイルで変更可能）

#### タスク詳細表示

```bash
task show <id>
```

- 指定タスクの全属性を表示する
- 依存関係（このタスクがブロックしているタスク、このタスクをブロックしているタスク）を表示する
- pinned状態を表示する

#### タスク一覧

```bash
task list [フィルタオプション]
```

- デフォルトは `pending` と `in_progress` のタスクを優先度スコア順で表示する
- 完了タスクはデフォルトで非表示。`--status=done` または `--all` で表示する
- フィルタ: `--tag`, `--status`, `--due-before`, `--due-after`
- 出力フォーマット: カラー表示（デフォルト）、`--json` でJSON出力

#### タスク編集

```bash
task edit <id> [オプション]
```

- 作成時と同じオプションで属性を更新
- `--title` でタイトル変更
- 属性を削除するには空文字を指定する: `--due=""`, `--note=""`
- タグの個別削除: `--remove-tag=frontend`

#### タスク削除

```bash
task delete <id>
```

- 確認プロンプトを表示（`--force` でスキップ可）

#### タスク検索

```bash
task search <query>
```

- タスクのタイトルとメモに対するフリーテキスト検索
- 完了タスクも検索対象に含める
- `--tag`, `--status` フィルタと組み合わせ可能

### 4.2 タスクステータス管理

```bash
task start <id>     # ステータスを「進行中」に変更
task done <id>      # ステータスを「完了」に変更
task pending <id>   # ステータスを「未着手」に戻す
```

| ステータス | 説明 |
|---|---|
| `pending` | 未着手（デフォルト） |
| `in_progress` | 進行中 |
| `done` | 完了 |

- `task done` 実行時、依存していたタスクのブロックが解除され、優先度が自動再計算される

### 4.3 優先度の自動調整

#### スコアリングシグナル

| シグナル | 説明 | デフォルト重み | 属性が未設定の場合 |
|---|---|---|---|
| 期限の接近（urgency） | 期限までの残り日数が少ないほど高スコア | `1.0` | シグナルを0として扱う（スコアに影響しない） |
| 依存タスク数（blocking） | 他タスクをブロックしている数が多いほど高スコア | `0.8` | 0（依存なし） |
| 放置期間（staleness） | 最終更新からの経過日数が長いほど高スコア | `0.5` | 作成日時を基準にする |
| タスク粒度（quick_win） | 見積もりが小さいほど高スコア（Quick Win優先） | `0.3` | シグナルを0として扱う（スコアに影響しない） |

#### 動作ルール

- すべての `pending` および `in_progress` タスクに対してスコアを算出する
- `task list` / `task next` / `task today` 実行時にスコアを再計算する
- ブロックされているタスク（依存先が未完了）は自動的にスコアが大幅に低下する
- スコア値はユーザーに直接公開しない。ソート順と簡易的な理由表示のみ

#### 簡易説明の表示

```bash
$ task next
→ #12 認証APIのエラーハンドリング
   due: 明日 | blocks: 3件 | 見積もり: 1h
```

- ソート基準となった主要因を1行で表示する

### 4.4 手動オーバーライド（pinned）

```bash
task pin <id>       # 優先度を固定（自動調整対象外にする）
task unpin <id>     # 固定を解除（自動調整に戻す）
```

- pinされたタスクは自動スコアリングの対象外となる
- `task list` ではpinnedタスクが最上位に表示される
- 複数タスクをpinした場合はpin実行時刻の昇順（先にpinしたものが上）で表示される
- `task add` 時に `--priority` オプションは提供しない。タスク作成後に `task pin` で明示的に固定する設計とする

### 4.5 依存関係管理

```bash
task depends <id> --on <id>     # 依存関係を追加
task undepends <id> --on <id>   # 依存関係を解除
task tree <id>                  # 依存関係ツリーを表示
```

**依存関係の方向:**
`task depends 5 --on 3` は「タスク#5 はタスク#3 に依存する」を意味する。つまり #3 が完了しなければ #5 に着手できない。

- 循環依存が発生する場合はエラーを返す
- ブロックされているタスク（依存先が未完了）は自動的に優先度が下がる

### 4.6 今日のタスク

```bash
task today
```

- 以下の条件に合致するタスクをスコア順で表示する:
  - 期限が今日以前のタスク
  - ステータスが `in_progress` のタスク
  - pinnedタスク
- 該当タスクがない場合は `task next` と同じ結果（最も優先度の高い1件）を表示する

### 4.7 出力フォーマット

- **デフォルト**: カラー付きの人間向け表示
- **`--json` フラグ**: スクリプト連携用のJSON出力
- **`--no-color` フラグ**: カラーなしのプレーンテキスト出力

### 4.8 タスクIDの採番

- タスクIDは1から始まる連番の整数とする
- 削除されたIDは再利用しない
- 次のIDは「これまでに採番された最大ID + 1」とする

### 4.9 設定ファイル

設定ファイルパス: `~/.config/taskctl/config.toml`

```toml
[priority.weights]
urgency = 1.0        # 期限の接近
blocking = 0.8       # 依存タスク数
staleness = 0.5      # 放置期間
quick_win = 0.3      # タスク粒度（Quick Win）

[estimate]
point_to_hours = 1.0 # 1ポイントを何時間として換算するか

[display]
color = true
date_format = "%Y-%m-%d"

[data]
directory = "~/.local/share/taskctl"
```

- 設定ファイルが存在しない場合は上記のデフォルト値で動作する
- `task init` コマンドでデフォルト設定ファイルを生成できる

## 5. 非機能要件

### パフォーマンス

- CLI起動時間: 100ms以下
- 1000タスク時のスコア再計算: 500ms以下
- Markdownファイルの読み書き: 100ms以下

### データ保存

- 形式: Markdown + YAML Front Matter（1タスク1ファイル方式。機能設計書で決定済み）
- 保存先: ローカルファイルシステム
- エンコーディング: UTF-8
- バックアップ: ユーザー責任（Git管理を推奨）

### データ整合性

- **同時アクセス**: ファイル書き込み時にロックファイル（`data_directory/.lock`）を使用し、複数ターミナルからの同時操作によるデータ競合を防止する
- **データ破損時の挙動**: Markdownファイルのパースに失敗した場合、該当ファイルをスキップしエラーメッセージを表示する。他の正常なタスクの操作は継続可能とする
- **データマイグレーション**: Front Matterにスキーマバージョンを含める。バージョン不一致を検出した場合、`task migrate` コマンドでマイグレーションを実行できる

### ポータビリティ

- Markdownファイルをテキストエディタで直接閲覧・編集可能
- データディレクトリをコピーするだけで環境移行可能

### 対応プラットフォーム

- macOS
- Linux
- Windows: WSL環境をサポート対象とする。ネイティブWindows（cmd.exe / PowerShell）はMVP範囲外

### 配布方法

- `cargo install taskctl` による配布を主要手段とする
- GitHub Releasesにプラットフォーム別のビルド済みバイナリを公開する
- Homebrew対応は将来検討

### シェル補完

- bash / zsh / fish のコマンド補完スクリプトを `task completions <shell>` コマンドで生成可能とする

### セキュリティ

- ネットワーク通信なし（完全オフライン動作）
- ファイルシステムのパーミッションに準拠

### 技術スタック

- 言語: Rust
- データ形式: Markdown + YAML Front Matter（タスク属性の構造化）
- 設定形式: TOML

## 6. MVP範囲

### MVP（v0.1）に含める

- タスクのCRUD（add / show / list / edit / delete / search）
- ステータス管理（start / done / pending）
- 優先度の自動調整（4シグナル）
- 手動オーバーライド（pin / unpin）
- 依存関係管理（depends / undepends / tree）
- 今日のタスク（today）、次のタスク（next）
- カラー表示 + JSON出力
- 設定ファイル対応（init）
- シェル補完（completions）

### MVP範囲外（将来検討）

- Git連携（コミットとタスクの紐付け）
- 繰り返しタスク
- 振り返り・統計機能
- エディタ拡張（VS Code / Vim）
- チーム向け機能（同期・共有）
- TUI（ターミナルUI）モード
- ネイティブWindows対応
- Homebrew対応

## 7. ユーザーストーリー

| # | ストーリー | 受け入れ条件 |
|---|---|---|
| US-01 | 開発者として、CLIからタスクを素早く追加したい。タスク管理のためにブラウザを開きたくないから。 | `task add` コマンド1行でタスクが作成され、Markdownファイルに保存される |
| US-02 | 開発者として、次に着手すべきタスクを即座に知りたい。優先順位の判断に時間をかけたくないから。 | `task next` で最も優先度の高いタスクが表示される。主要なソート基準が1行で確認できる |
| US-03 | 開発者として、タスク完了時に依存タスクのブロックが自動解除されてほしい。手動で更新するのは面倒だから。 | `task done` 実行後、依存タスクの優先度が自動再計算される |
| US-04 | 開発者として、特定のタスクの優先度を手動で固定したい。自動調整では判断できない緊急事態があるから。 | `task pin` で固定されたタスクは自動調整の対象外となり、リスト最上位に表示される |
| US-05 | 開発者として、タスクデータをGitで管理したい。データをバージョン管理して安心したいから。 | Markdownファイルとして保存され、差分が読みやすい形式になっている |
| US-06 | 開発者として、タスク一覧をスクリプトから利用したい。他ツールと連携させたいから。 | `--json` フラグでJSON形式の出力が得られる |
| US-07 | 開発者として、優先度の算出基準をカスタマイズしたい。自分のワークスタイルに合わせたいから。 | 設定ファイルで各シグナルの重みを変更できる |
| US-08 | 開発者として、タスクの詳細を素早く確認したい。一覧では情報が足りないことがあるから。 | `task show <id>` で全属性・依存関係・pinned状態が表示される |
| US-09 | 開発者として、過去のタスクをキーワードで探したい。完了済みタスクの内容を参照したいことがあるから。 | `task search <query>` でタイトル・メモをフリーテキスト検索できる |
| US-10 | 開発者として、今日集中すべきタスクだけを見たい。全タスクを見ると気が散るから。 | `task today` で期限が今日以前・進行中・pinnedのタスクが表示される |
